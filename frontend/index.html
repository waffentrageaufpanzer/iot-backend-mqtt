<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>IoT Platform</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body data-theme="dark">
  <!-- AUTH PAGE -->
  <div id="authPage" class="full-center">
    <div class="auth-card">
      <div class="auth-topbar">
        <div class="lang-toggle" id="authLangToggle">
          <button type="button" data-lang="vi">VI</button>
          <button type="button" data-lang="en">EN</button>
        </div>
        <button type="button" class="icon-btn" id="authThemeToggle">üåô</button>
      </div>

      <h1 class="auth-title" data-i18n-key="auth.title">IoT Platform</h1>
      <p class="small" data-i18n-key="auth.subtitle">ƒêƒÉng nh·∫≠p ƒë·ªÉ qu·∫£n l√Ω thi·∫øt b·ªã.</p>

      <!-- backend URL -->
      <div class="row" style="margin-top:4px;">
        <button class="secondary btn-sm" type="button" id="toggleApiBaseBtn">
          ‚öô Backend URL
        </button>
      </div>
      <div class="row" id="apiBaseRow" style="display:none;">
        <input id="apiBaseInput" placeholder="https://...railway.app" />
        <button class="secondary btn-sm" id="saveApiBaseBtn" type="button">L∆∞u</button>
      </div>

      <div class="tabs">
        <button id="tabLogin" class="active" type="button" data-i18n-key="auth.loginTab">
          ƒêƒÉng nh·∫≠p
        </button>
        <button id="tabRegister" type="button" data-i18n-key="auth.registerTab">
          ƒêƒÉng k√Ω
        </button>
      </div>

      <!-- LOGIN -->
      <div id="loginForm">
        <div class="row">
          <input id="loginUser" placeholder="Username" />
        </div>
        <div class="row">
          <input id="loginPass" type="password" placeholder="Password" />
        </div>
        <div class="row">
          <button id="loginBtn" type="button" data-i18n-key="auth.loginBtn">
            ƒêƒÉng nh·∫≠p
          </button>
        </div>
      </div>

      <!-- REGISTER -->
      <div id="registerForm" style="display:none;">
        <div class="row">
          <input id="regUser" placeholder="Username" />
        </div>
        <div class="row">
          <input id="regEmail" type="email" placeholder="Email" />
        </div>
        <div class="row">
          <input id="regPass" type="password" placeholder="Password" />
        </div>
        <div class="row">
          <input id="regPassConfirm" type="password" placeholder="Confirm password" />
        </div>
        <div class="row">
          <button id="registerBtn" type="button" data-i18n-key="auth.registerBtn">
            T·∫°o t√†i kho·∫£n
          </button>
        </div>

        <div class="row">
          <div class="small">OTP email (n·∫øu c√≥):</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <input id="otpInput" placeholder="6 s·ªë" style="max-width:110px;" />
            <button class="secondary btn-sm" id="verifyOtpBtn" type="button">X√°c nh·∫≠n</button>
            <button class="secondary btn-sm" id="resendOtpBtn" type="button">G·ª≠i l·∫°i</button>
          </div>
        </div>
      </div>

      <div id="authMessage" class="small">Ch∆∞a ƒëƒÉng nh·∫≠p.</div>
    </div>
  </div>

  <!-- APP PAGE -->
  <div id="appPage" style="display:none;">
    <div class="layout">
      <!-- SIDEBAR -->
      <aside class="sidebar" id="sideNav">
        <div class="sidebar-top">
          <span class="sidebar-logo">IoT</span>
          <button class="icon-btn" type="button" id="sideNavToggle">‚ò∞</button>
        </div>
        <div class="sidebar-nav">
          <button type="button" class="nav-item active" data-tab="dashboard">
            <span class="nav-icon">üìä</span>
            <span class="nav-label" data-i18n-key="nav.dashboard">Dashboard</span>
          </button>
          <button type="button" class="nav-item" data-tab="devices">
            <span class="nav-icon">üîå</span>
            <span class="nav-label" data-i18n-key="nav.devices">Thi·∫øt b·ªã</span>
          </button>
          <button type="button" class="nav-item" data-tab="cameras">
            <span class="nav-icon">üì∑</span>
            <span class="nav-label" data-i18n-key="nav.cameras">Camera</span>
          </button>
          <button
            type="button"
            class="nav-item"
            data-tab="admin"
            id="navAdmin"
            style="display:none;"
          >
            <span class="nav-icon">üõ°Ô∏è</span>
            <span class="nav-label" data-i18n-key="nav.admin">Admin</span>
          </button>
        </div>
      </aside>

      <!-- MAIN -->
      <div class="card">
        <div class="app-header">
          <div class="app-title-text" data-i18n-key="app.title">IoT Platform</div>
          <div class="header-right">
            <span id="healthBadge" class="pill pill-red">Backend</span>
            <span id="userBadge" class="pill small"></span>
            <div class="lang-toggle" id="appLangToggle">
              <button type="button" data-lang="vi">VI</button>
              <button type="button" data-lang="en">EN</button>
            </div>
            <button type="button" class="icon-btn" id="appThemeToggle">üåô</button>
            <button
              id="changePassBtn"
              class="secondary btn-sm"
              type="button"
              data-i18n-key="app.changePass"
            >
              ƒê·ªïi m·∫≠t kh·∫©u
            </button>
            <button
              id="logoutBtn"
              class="secondary btn-sm"
              type="button"
              data-i18n-key="app.logout"
            >
              ƒêƒÉng xu·∫•t
            </button>
          </div>
        </div>

        <!-- DASHBOARD -->
        <section id="dashboardSection">
          <div class="dash-toolbar">
            <div class="dash-title-row">
              <div class="dash-title" data-i18n-key="dash.title">Dashboard</div>
              <button id="dashModeBtn" type="button" class="secondary btn-sm">Edit</button>
            </div>
            <div class="widget-palette">
              <button class="widget-add-main" type="button" id="widgetPaletteToggle">
                <span>Ôºã</span>
                <span data-i18n-key="dash.addWidget">Th√™m widget</span>
                <span class="widget-add-caret">‚ñæ</span>
              </button>
              <div class="widget-palette-menu" id="widgetPaletteMenu">
                <button class="widget-type-btn" data-type="button">
                <span>üü£</span><span>Button</span></button>
                <button class="widget-type-btn" type="button" data-type="switch">
                  <span>‚èª</span><span>C√¥ng t·∫Øc</span>
                </button>
                <button class="widget-type-btn" type="button" data-type="slider">
                  <span>üéöÔ∏è</span><span>Analog</span>
                </button>
                <button class="widget-type-btn" type="button" data-type="thermo">
                  <span>üå°Ô∏è</span><span>Temp</span>
                </button>
                <button class="widget-type-btn" type="button" data-type="gauge">
                  <span>üìà</span><span>Gauge</span>
                </button>
                <button class="widget-type-btn" type="button" data-type="dpad">
                  <span>üïπÔ∏è</span><span>D-Pad</span>
                </button>
                <button class="widget-type-btn" type="button" data-type="camera">
                  <span>üì∑</span><span>Camera</span>
                </button>
              </div>
            </div>
          </div>
          <div class="widget-layout">
            <div id="widgetGrid" class="widget-grid">
              <div class="empty-hint">Ch∆∞a c√≥ widget.</div>
            </div>
          </div>
        </section>

        <!-- DEVICES -->
        <section id="devicesSection" style="display:none;">
          <div class="row">
            <input id="searchInput" placeholder="Search ID / name" />
          </div>
          <div class="row" style="margin-top:4px;flex-direction:row;gap:6px;">
            <button class="secondary btn-sm" id="toggleAutoBtn" type="button">Auto: OFF</button>
            <button id="refreshBtn" class="btn-sm" type="button">Refresh</button>
            <span class="small" id="status">...</span>
          </div>
          <div class="row" style="margin-top:6px;flex-direction:row;gap:6px;">
            <input id="claimDeviceId" placeholder="Device ID" style="max-width:150px;" />
            <input id="claimDeviceName" placeholder="Name" style="max-width:150px;" />
            <button class="secondary btn-sm" id="claimBtn" type="button">Claim</button>
          </div>

          <div class="device-list-wrapper">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>T√™n</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>Gi√° tr·ªã</th>
                  <th>C·∫≠p nh·∫≠t</th>
                  <th>Ctrl</th>
                </tr>
              </thead>
              <tbody id="deviceTableBody">
                <tr><td colspan="6" class="small">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>
              </tbody>
            </table>
          </div>

          <!-- FIRMWARE -->
          <hr style="margin:8px 0;border-color:#1f2937;" />
          <div class="row">
            <div class="small"><b>ESP32 firmware (MQTT)</b></div>
          </div>
          <div
            class="row"
            style="margin-top:4px;flex-direction:row;gap:6px;flex-wrap:wrap;"
          >
            <input id="fwDeviceId" placeholder="Device ID" style="max-width:150px;" />
            <input id="fwDeviceName" placeholder="T√™n thi·∫øt b·ªã" style="max-width:180px;" />
          </div>
          <div
            class="row"
            style="margin-top:4px;flex-direction:row;gap:6px;flex-wrap:wrap;"
          >
            <input id="fwWifiSsid" placeholder="WiFi SSID" style="max-width:160px;" />
            <input id="fwWifiPass" placeholder="WiFi pass" style="max-width:160px;" />
          </div>
          <div
            class="row"
            style="margin-top:4px;flex-direction:row;gap:6px;flex-wrap:wrap;"
          >
            <input id="fwMqttHost" placeholder="MQTT host" style="max-width:210px;" />
            <input id="fwMqttPort" placeholder="Port" style="max-width:80px;" />
          </div>
          <div class="row" style="margin-top:4px;">
            <table style="font-size:11px;width:100%;border-collapse:collapse;">
              <thead>
                <tr>
                  <th>T√™n</th>
                  <th>GPIO</th>
                  <th>Ki·ªÉu</th>
                  <th>Xo√°</th>
                </tr>
              </thead>
              <tbody id="fwPinsTableBody"></tbody>
            </table>
            <button
              id="fwAddPinBtn"
              class="secondary btn-sm"
              type="button"
              style="margin-top:4px;"
            >
              Th√™m ch√¢n
            </button>
          </div>
          <div
            class="row"
            style="margin-top:4px;flex-direction:row;gap:6px;flex-wrap:wrap;align-items:center;"
          >
            <button id="fwGenerateBtn" class="btn-sm" type="button">Generate</button>
            <button id="fwCopyBtn" class="secondary btn-sm" type="button">Copy code</button>
            <span class="small" id="fwCopyStatus"></span>
          </div>
          <div class="row" style="margin-top:4px;">
            <textarea
              id="fwCodeOutput"
              style="
                width:100%;
                min-height:230px;
                font-family:monospace;
                font-size:12px;
                background:#020617;
                color:#e5e7eb;
                border-radius:10px;
                border:1px solid #111827;
                padding:8px;
              "
            ></textarea>
          </div>
        </section>

        <!-- CAMERAS -->
        <section id="camerasSection" style="display:none;">
          <div class="row" style="flex-direction:row;gap:6px;">
            <input id="camIdInput" placeholder="Camera ID" style="max-width:120px;" />
            <input id="camNameInput" placeholder="T√™n" style="max-width:140px;" />
          </div>
          <div class="row">
            <input id="camUrlInput" placeholder="Snapshot URL" />
          </div>
          <div
            class="row"
            style="margin-top:4px;flex-direction:row;gap:6px;align-items:center;"
          >
            <button id="camRegisterBtn" class="secondary btn-sm" type="button">
              L∆∞u camera
            </button>
            <span class="small" id="camStatus">...</span>
          </div>
          <div class="device-list-wrapper">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>T√™n</th>
                  <th>Thao t√°c</th>
                </tr>
              </thead>
              <tbody id="cameraTableBody">
                <tr><td colspan="3" class="small">Ch∆∞a c√≥ camera.</td></tr>
              </tbody>
            </table>
          </div>

          <hr style="margin:8px 0;border-color:#1f2937;" />
          <div class="row">
            <div class="small"><b>Laptop camera stream</b></div>
          </div>
          <div
            class="row"
            style="margin-top:4px;flex-direction:row;gap:6px;align-items:center;"
          >
            <button id="startStreamBtn" class="secondary btn-sm" type="button">Start</button>
            <button id="stopStreamBtn" class="danger btn-sm" type="button" disabled>
              Stop
            </button>
          </div>
          <div class="row" style="margin-top:6px;">
            <div class="small">Local preview:</div>
            <video
              id="localVideo"
              autoplay
              muted
              playsinline
              style="width:100%;max-height:180px;border-radius:9px;"
            ></video>
          </div>
          <div class="row" style="margin-top:6px;">
            <div class="small">Backend frame:</div>
            <img id="serverVideo" />
            <div id="camStreamStatus" class="small">...</div>
          </div>
        </section>

        <!-- ADMIN -->
        <section id="adminSection" style="display:none;">
          <div class="row">
            <div class="small">Qu·∫£n l√Ω user (admin).</div>
          </div>
          <div class="device-list-wrapper">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>T·∫°o l√∫c</th>
                  <th>Thao t√°c</th>
                </tr>
              </thead>
              <tbody id="adminUserTableBody">
                <tr><td colspan="6" class="small">...</td></tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- DETAIL CARD -->
      <div class="card detail-card">
        <h2 style="margin:0 0 6px;font-size:14px;display:flex;align-items:center;gap:5px;">
          Chi ti·∫øt
        </h2>
        <div id="detailEmpty">Ch·ªçn 1 device / camera.</div>

        <div id="deviceDetailPanel" style="display:none;">
          <div class="small">Device ID</div>
          <div id="detailId"></div>
          <div class="small" style="margin-top:4px;">T√™n</div>
          <div id="detailName"></div>
          <div class="small" style="margin-top:4px;">Tr·∫°ng th√°i</div>
          <div id="detailState"></div>
          <div class="small" style="margin-top:4px;">Gi√° tr·ªã</div>
          <div id="detailValue"></div>
          <div class="small" style="margin-top:4px;">C·∫≠p nh·∫≠t</div>
          <div id="detailUpdated"></div>
          <div class="small" style="margin-top:4px;">Sensors</div>
          <div id="detailSensors" class="small"></div>
          <div class="small" style="margin-top:4px;">History (trong phi√™n)</div>
          <canvas id="historyCanvas"></canvas>
        </div>

        <div id="cameraDetailPanel" style="display:none;">
          <div class="small">Camera ID</div>
          <div id="camDetailId"></div>
          <div class="small" style="margin-top:4px;">T√™n</div>
          <div id="camDetailName"></div>
          <div class="small" style="margin-top:4px;">URL</div>
          <div id="camDetailUrl" class="small"></div>
          <div class="small" style="margin-top:4px;">Snapshot</div>
          <div style="margin-top:4px;">
            <img id="camDetailImg" class="cam-preview" alt="Camera snapshot" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- WIDGET CONFIG POPUP -->
  <div id="widgetConfigOverlay" class="widget-config-overlay">
    <div id="widgetConfigPanel" class="widget-config">
      <div class="widget-config-header">
        <span>C·∫•u h√¨nh widget</span>
        <button type="button" class="icon-btn btn-sm" id="widgetConfigCloseBtn">‚úï</button>
      </div>
      <div class="widget-config-empty">Ch·ªçn 1 widget ƒë·ªÉ ch·ªânh.</div>
      <div class="widget-config-form">
        <div class="widget-config-row">
          <span>T√™n</span>
          <input id="widgetConfigTitle" placeholder="T√™n widget" />
        </div>
        <div class="widget-config-row" id="widgetConfigDeviceRow">
          <span>Device ID</span>
          <select id="widgetConfigDevice"></select>
        </div>
        <div class="widget-config-row" id="widgetConfigCameraRow" style="display:none;">
          <span>Camera ID</span>
          <select id="widgetConfigCamera"></select>
        </div>
        <div class="widget-config-row">
          <span>M√†u</span>
          <select id="widgetConfigTheme">
            <option value="green">Xanh l√°</option>
            <option value="blue">Xanh d∆∞∆°ng</option>
            <option value="amber">V√†ng cam</option>
            <option value="pink">H·ªìng</option>
            <option value="gray">X√°m</option>
          </select>
        </div>
        <!-- NEW: ch·ªçn k√≠ch th∆∞·ªõc widget -->
        <div class="widget-config-row">
          <span>K√≠ch th∆∞·ªõc</span>
          <select id="widgetConfigSize">
            <option value="s">Nh·ªè</option>
            <option value="m" selected>V·ª´a</option>
            <option value="l">L·ªõn</option>
          </select>
        </div>
        <div class="widget-config-row" id="widgetConfigRangeRow" style="display:none;">
          <span>Range</span>
          <input
            id="widgetConfigRangeMin"
            type="number"
            style="max-width:70px;"
            placeholder="Min"
          />
          <input
            id="widgetConfigRangeMax"
            type="number"
            style="max-width:70px;"
            placeholder="Max"
          />
        </div>
      </div>
    </div>
  </div>

  <script src="app.js" defer></script>
</body>
</html>
